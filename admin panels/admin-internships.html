<!DOCTYPE html>
<html>
<head>
  <title>Admin - Internships</title>
  <link rel="stylesheet" href="admin.css">

  <!-- PDF LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- ================= TOP BAR ================= -->
<div class="admin-topbar">Admin Panel</div>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <h2>TNP Admin</h2>
  <div class="menu-item" onclick="location.href='admin.html'">Dashboard</div>
  <div class="menu-item" onclick="location.href='admin-events.html'">Events</div>
  <div class="menu-item active">Internships</div>
  <div class="menu-item" onclick="location.href='admin-training.html'">Training</div>
  <div class="menu-item" onclick="location.href='admin-placements.html'">Placements</div>
</div>

<!-- ================= MAIN ================= -->
<div class="main">
  <h1>Internships</h1>

  <button class="add-btn" onclick="openInternshipModal()">+ Add Internship</button>
  <button class="add-btn" onclick="exportApplicantsPDF()">Export Applicants PDF</button>

  <table>
    <thead>
      <tr>
        <th>Internship Name</th>
        <th>Organization</th>
        <th>Location</th>
        <th>Stipend</th>
        <th>Duration</th>
        <th>Last Date</th>
        <th>Description</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="internshipTable"></tbody>
  </table>
</div>

<!-- ================= ADD / EDIT MODAL ================= -->
<div class="modal-bg" id="internshipModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="internshipTitle">Add Internship</h2>
      <button class="btn cancel" onclick="closeInternshipModal()">X</button>
    </div>

    <div class="modal-body">
      <div class="form-row">
        <label>Internship Name</label>
        <input id="iname">
      </div>

      <div class="form-row">
        <label>Organization</label>
        <input id="iorg">
      </div>

      <div class="form-row">
        <label>Location</label>
        <input id="iloc">
      </div>

      <div class="form-row">
        <label>Stipend</label>
        <input id="istipend">
      </div>

      <div class="form-row">
        <label>Duration</label>
        <input id="idur">
      </div>

      <div class="form-row">
        <label>Last Date</label>
        <input type="date" id="ild">
      </div>

      <div class="form-row">
        <label>Description</label>
        <textarea id="idesc"></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn cancel" onclick="closeInternshipModal()">Cancel</button>
      <button class="btn" onclick="saveInternship()">Save</button>
    </div>
  </div>
</div>

<!-- ================= APPLICANTS MODAL ================= -->
<div class="modal-bg" id="applicantModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="applicantTitle">Applicants</h2>
      <button class="btn cancel" onclick="closeApplicantModal()">X</button>
    </div>

    <div class="modal-body">
      <button class="add-btn" onclick="exportSingleInternshipPDF()">
        Export Applicants PDF
      </button>
      <br><br>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Year & Branch</th>
            <th>Resume</th>
          </tr>
        </thead>
        <tbody id="applicantTable"></tbody>
      </table>
    </div>

    <div class="modal-footer">
      <button class="btn cancel" onclick="closeApplicantModal()">Close</button>
    </div>
  </div>
</div>

<script>
/* ================= VARIABLES ================= */

let editIndex = -1;
let currentInternshipIndex = -1;

const INT_KEY = "tnp_internships";
const APP_KEY = "tnp_internship_applicants";

/* ================= STORAGE ================= */

const loadInternships = () =>
  JSON.parse(localStorage.getItem(INT_KEY) || "[]");

const saveInternships = d =>
  localStorage.setItem(INT_KEY, JSON.stringify(d));

const loadApplicants = () =>
  JSON.parse(localStorage.getItem(APP_KEY) || "{}");

/* ================= RENDER ================= */

function renderInternships(){
  internshipTable.innerHTML = "";

  loadInternships().forEach((i,idx)=>{
    internshipTable.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td>${i.org}</td>
        <td>${i.loc}</td>
        <td>${i.stipend}</td>
        <td>${i.dur}</td>
        <td>${i.ld}</td>
        <td>${i.desc}</td>
        <td>
          <button class="edit-btn" onclick="editInternship(${idx})">Edit</button>
          <button class="del-btn" onclick="deleteInternship(${idx})">Delete</button>
          <button class="edit-btn" onclick="viewApplicants(${idx})">Applicants</button>
        </td>
      </tr>
    `;
  });
}

/* ================= MODAL ================= */

function openInternshipModal(){
  editIndex = -1;
  internshipTitle.innerText = "Add Internship";
  document.querySelectorAll("#internshipModal input, #internshipModal textarea")
    .forEach(i=>i.value="");
  internshipModal.style.display = "flex";
}

function closeInternshipModal(){
  internshipModal.style.display = "none";
}

function saveInternship(){
  const obj = {
    name: iname.value,
    org: iorg.value,
    loc: iloc.value,
    stipend: istipend.value,
    dur: idur.value,
    ld: ild.value,
    desc: idesc.value
  };

  if(!obj.name){
    alert("Internship name required");
    return;
  }

  const data = loadInternships();
  editIndex === -1 ? data.push(obj) : data[editIndex] = obj;
  saveInternships(data);
  closeInternshipModal();
  renderInternships();
}

function editInternship(i){
  const d = loadInternships()[i];
  editIndex = i;

  iname.value = d.name;
  iorg.value = d.org;
  iloc.value = d.loc;
  istipend.value = d.stipend;
  idur.value = d.dur;
  ild.value = d.ld;
  idesc.value = d.desc;

  internshipTitle.innerText = "Edit Internship";
  internshipModal.style.display = "flex";
}

function deleteInternship(i){
  if(confirm("Delete this internship?")){
    const d = loadInternships();
    d.splice(i,1);
    saveInternships(d);
    renderInternships();
  }
}

/* ================= APPLICANTS ================= */

function viewApplicants(i){
  currentInternshipIndex = i;
  applicantTitle.innerText =
    "Applicants for: " + loadInternships()[i].name;

  const apps = loadApplicants()[i] || [];
  applicantTable.innerHTML = "";

  if(apps.length === 0){
    applicantTable.innerHTML =
      `<tr><td colspan="5">No applicants</td></tr>`;
  } else {
    apps.forEach(a=>{
      applicantTable.innerHTML += `
        <tr>
          <td>${a.name}</td>
          <td>${a.email}</td>
          <td>${a.phone}</td>
          <td>${a.year}</td>
          <td>
            <a href="${a.resume}" target="_blank">View</a>
          </td>
        </tr>
      `;
    });
  }

  applicantModal.style.display = "flex";
}

function closeApplicantModal(){
  applicantModal.style.display = "none";
}

/* ================= EXPORT PDF ================= */

function exportSingleInternshipPDF(){
  const apps = loadApplicants()[currentInternshipIndex] || [];
  if(apps.length === 0){
    alert("No applicants to export");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text("Internship Applicants", 14, 15);

  doc.autoTable({
    startY: 25,
    head: [["Name","Email","Phone","Year & Branch"]],
    body: apps.map(a=>[a.name,a.email,a.phone,a.year]),
    theme:"grid"
  });

  doc.save("Internship_Applicants.pdf");
}

/* ================= INIT ================= */

renderInternships();
</script>

</body>
</html>
